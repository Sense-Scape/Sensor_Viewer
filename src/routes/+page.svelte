<script lang="ts">
	import Chart from 'chart.js/auto';
	import SensorGroup from '$lib/SensorGroup.svelte';
	import { onMount } from 'svelte';
	import { writable } from 'svelte/store';

	// Create a writable store initialized as an empty object (to mimic a map)
	var mapData = [];

	function updateItemInMap(key, value) {
		// Start by checking if we have seen this source identifier before
		let index = -1;
		for (let i = 0; i < mapData.length; i++) {
			if (JSON.stringify(mapData[i].key) === JSON.stringify(key)) {
				index = i;
				break;
			}
		}
		// If not add it to our array
		if (index == -1) {
			if (mapData.length == 0) {
				index = 0;
				mapData[index] = {
					key: key,
					value: value
				};
			} else {
				index = mapData.length;

				mapData[index] = {
					key: key,
					value: value
				};
			}
			console.log('Added at index:  ' + index);
		} else {
			// If we have seen it, update its values
			for (const key in value) {
				mapData[index].value[key] = JSON.parse(JSON.stringify(value[key]));
			}
		}
	}

	// Create the time domain chart and link mount it to the HTML canvas
	onMount(() => {
		const TimeWebSocket = new WebSocket('ws://localhost:10100/DataTypes/TimeChunk');

		// console.log(sensorGroup);
		TimeWebSocket.addEventListener('message', async (event) => {
			var timeParsedData = JSON.parse(event.data);
			let timeDatasets = [];

			// COnvert data to array
			const newData = timeParsedData['TimeChunk']['Channels'];
			const numChannels = timeParsedData['TimeChunk']['NumChannels'];
			for (let channelIndex = 0; channelIndex < numChannels; channelIndex++) {
				timeDatasets[channelIndex] = newData[channelIndex];
			}

			// console.log(newData);
			updateItemInMap(timeParsedData['TimeChunk']['SourceIdentifier'], {
				timeSampleRate: timeParsedData['TimeChunk']['SampleRate'],
				timeChunkSize: timeParsedData['TimeChunk']['ChunkSize'],
				sourceIdentifier: timeParsedData['TimeChunk']['SourceIdentifier'],
				TimeDomainYValues: timeDatasets,
				TimeDomainXValues: Array.from({ length: 512 }, (_, index) => index + 1),
				timeID: timeParsedData['TimeChunk']['SourceIdentifier'] + '-time',
				freqID: timeParsedData['TimeChunk']['SourceIdentifier'] + '-freq'
			});
		});

		const FreqWebSocket = new WebSocket('ws://localhost:10100/DataTypes/FFTMagnitudeChunk');
		let FreqParsedData = null;
		let freqDatasets = [];
		FreqWebSocket.addEventListener('message', async (event) => {
			FreqParsedData = JSON.parse(event.data);

			const newData = FreqParsedData['FFTMagnitudeChunk']['Channels'];
			const numChannels = FreqParsedData['FFTMagnitudeChunk']['NumChannels'];
			for (let channelIndex = 0; channelIndex < numChannels; channelIndex++) {
				freqDatasets[channelIndex] = newData[channelIndex];
			}

			updateItemInMap(FreqParsedData['FFTMagnitudeChunk']['SourceIdentifier'], {
				freqSampleRate: FreqParsedData['FFTMagnitudeChunk']['SampleRate'],
				freqChunkSize: FreqParsedData['FFTMagnitudeChunk']['ChunkSize'],
				sourceIdentifier: FreqParsedData['FFTMagnitudeChunk']['SourceIdentifier'],
				FreqDomainYValues: freqDatasets,
				FreqDomainXValues: Array.from({ length: 512 }, (_, index) => index + 1),
				freqID: FreqParsedData['FFTMagnitudeChunk']['SourceIdentifier'] + '-freq',
				timeID: FreqParsedData['FFTMagnitudeChunk']['SourceIdentifier'] + '-time'
			});
		});
	});
</script>

<svelte:head>
	<title>Sense-Scape | Overview</title>
	<meta name="description" content="Some sweet description words" />

	<!-- Open Graph Meta Tags -->
	<meta property="og:title" content="Sense-Scape | Overview" />
	<meta property="og:site_name" content="Sense Scape Site" />
	<!-- TODO make this dynamic -->
	<meta property="og:url" content="https://svelte-website-inky.vercel.app/" />
	<meta property="og:description" content="Some sweet description words for Open Graph" />
	<meta property="og:type" content="website" />
	<!-- <meta property="og:image" content="" /> -->

	<!-- Twitter Meta Tags -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta property="twitter:domain" content="svelte-website-inky.vercel.app" />
	<!-- TODO make this dynamic -->
	<meta property="twitter:url" content="https://svelte-website-inky.vercel.app/" />
	<meta name="twitter:title" content="Sense-Scape | Overview" />
	<meta name="twitter:description" content="Some sweet description words for twitter" />
	<!-- <meta name="twitter:image" content=""> -->
</svelte:head>

<div>
	<div id="sensors">
		{#each mapData as data}
			<SensorGroup {...data.value} />
		{/each}
	</div>
</div>

<style>
</style>
